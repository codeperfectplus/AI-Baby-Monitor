<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RTSP Baby Monitor AI Stream</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>👶</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

</head>

<body class="text-white">
    <!-- Particles Background -->
    <div id="particles-js"></div>

    <!-- Enhanced Floating particles background -->
    <div class="fixed inset-0 pointer-events-none">
        <div class="floating-particle w-1 h-1" style="left: 5%; animation-delay: 0s;"></div>
        <div class="floating-particle w-2 h-2" style="left: 15%; animation-delay: 1s;"></div>
        <div class="floating-particle w-1 h-1" style="left: 25%; animation-delay: 2s;"></div>
        <div class="floating-particle w-3 h-3" style="left: 35%; animation-delay: 3s;"></div>
        <div class="floating-particle w-1 h-1" style="left: 45%; animation-delay: 4s;"></div>
        <div class="floating-particle w-2 h-2" style="left: 55%; animation-delay: 5s;"></div>
        <div class="floating-particle w-1 h-1" style="left: 65%; animation-delay: 6s;"></div>
        <div class="floating-particle w-2 h-2" style="left: 75%; animation-delay: 7s;"></div>
        <div class="floating-particle w-1 h-1" style="left: 85%; animation-delay: 8s;"></div>
        <div class="floating-particle w-2 h-2" style="left: 95%; animation-delay: 9s;"></div>
    </div>

    <!-- Enhanced Navigation -->
    <nav class="fixed top-0 w-full glass-card border-b border-white/10" data-aos="fade-down">
        <div class="container mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-r from-cyan-400 to-purple-600 flex items-center justify-center hover-lift">
                    <i class="fas fa-baby text-white text-lg"></i>
                </div>
                <span class="text-xl font-bold gradient-text">AI Baby Monitor</span>
                <small class="text-xs text-cyan-400 ml-2 opacity-80">by CodePerfectPlus</small>
            </div>
            <div class="flex items-center gap-6">
                <div class="notifications-container">
                    <button class="nav-link relative hover-lift" onclick="toggleNotifications()">
                        <i class="fas fa-bell mr-2"></i>Notifications
                        <span id="notification-badge" class="notification-badge" style="display: none;">0</span>
                    </button>
                    <div id="notifications-dropdown" class="notifications-dropdown">
                        <div class="p-3 border-b border-white/10 flex justify-between items-center">
                            <h3 class="font-semibold text-white">Recent Notifications</h3>
                            <button onclick="clearAllNotifications()"
                                class="text-xs text-red-400 hover:text-red-300 transition-colors hover:scale-110 transform px-2 py-1 rounded bg-red-500 bg-opacity-10 border border-red-400 border-opacity-20">
                                <i class="fas fa-trash-alt mr-1"></i>Clear All
                            </button>
                        </div>
                        <div id="notifications-list" class="max-h-64 overflow-y-auto scrollbar-hide">
                            <div class="p-4 text-center text-gray-400 text-sm">
                                <div class="loading-spinner mx-auto mb-3"></div>
                                <i class="fas fa-bell-slash text-4xl mb-3 opacity-50 animate-pulse"></i>
                                <p class="font-medium">No notifications yet</p>
                                <p class="text-xs mt-2 opacity-70">You'll be notified of important events</p>
                                <div class="mt-3 flex justify-center space-x-2">
                                    <div class="w-2 h-2 bg-cyan-400 rounded-full opacity-30"></div>
                                    <div class="w-2 h-2 bg-purple-400 rounded-full opacity-30"></div>
                                    <div class="w-2 h-2 bg-green-400 rounded-full opacity-30"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced User Menu -->
                <div class="relative user-menu">
                    <button class="nav-link flex items-center hover-lift" onclick="toggleUserMenu()">
                        <div
                            class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-white font-medium mr-2 shadow-lg">
                            {{ current_user.username[0].upper() }}
                        </div>
                        <div class="flex flex-col items-start">
                            <span class="font-medium">{{ current_user.username }}</span>
                            <span class="text-xs text-cyan-400">{{ current_user.relationship or 'Guardian' }}</span>
                        </div>
                        <i class="fas fa-chevron-down ml-2 text-xs transition-transform"></i>
                    </button>
                    <div id="user-dropdown" class="user-dropdown">
                        <div class="p-3 border-b border-white/10">
                            <p class="text-white font-medium">{{ current_user.username }}</p>
                            <p class="text-cyan-400 text-sm">{{ current_user.relationship or 'Guardian' }}</p>
                            <p class="text-gray-400 text-xs">{{ current_user.email }}</p>
                        </div>
                        {% if current_user.is_admin %}
                        <a href="{{ url_for('auth.user_management') }}" class="dropdown-item">
                            <i class="fas fa-users mr-3"></i>User Management
                        </a>
                        <a href="{{ url_for('auth.login_logs') }}" class="dropdown-item">
                            <i class="fas fa-history mr-3"></i>Login Logs
                        </a>
                        {% endif %}
                        <a href="{{ url_for('auth.change_password') }}" class="dropdown-item">
                            <i class="fas fa-key mr-3"></i>Change Password
                        </a>
                        <div class="border-t border-white/10"></div>
                        <a href="{{ url_for('auth.logout') }}" class="dropdown-item text-red-400 hover:text-red-300">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 pt-24 pb-12">
        <!-- Enhanced Header Section -->
        <div class="text-center mb-12" data-aos="fade-up">
            <h1 class="text-6xl font-extrabold mb-4">
                <span class="gradient-text">
                    AI-Powered Baby Monitor
                </span>
            </h1>
            <p class="text-xl text-gray-300 mb-4 max-w-3xl mx-auto" data-aos="fade-up" data-aos-delay="200">
                Advanced real-time monitoring with computer vision, sleep analysis, and intelligent safety alerts
            </p>

            <!-- Enhanced Status Bar -->
            <div class="flex items-center justify-center gap-8 mb-8" data-aos="fade-up" data-aos-delay="400">
                <div class="flex items-center gap-2 hover-lift">
                    <div class="w-3 h-3 rounded-full status-dot"></div>
                    <span class="text-green-400 font-medium">Live Stream Active</span>
                </div>
                <div class="flex items-center gap-2 hover-lift">
                    <div class="ai-indicator w-3 h-3 rounded-full"></div>
                    <span class="text-orange-400 font-medium">AI Processing</span>
                </div>
                <div class="flex items-center gap-2 hover-lift">
                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                    <span class="text-blue-400 font-medium">Safe Zone OK</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-4 gap-8">
            <!-- Enhanced Video Section -->
            <div class="xl:col-span-3">
                <div class="glass-card rounded-3xl p-6 mb-6 hover-lift" data-aos="fade-right">
                    <!-- Enhanced Live Metrics -->
                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="metric-card rounded-xl p-4 text-center hover-lift" data-aos="zoom-in"
                            data-aos-delay="100">
                            <div class="text-2xl font-bold text-cyan-400" id="detection-rate">98%</div>
                            <div class="text-sm text-gray-400">Detection Rate</div>
                            <div class="progress-bar w-full h-1 mt-2">
                                <div class="progress-fill" style="width: 98%"></div>
                            </div>
                        </div>
                        <div class="metric-card rounded-xl p-4 text-center hover-lift" data-aos="zoom-in"
                            data-aos-delay="200">
                            <div class="text-2xl font-bold text-green-400" id="sleep-state">Sleep</div>
                            <div class="text-sm text-gray-400">State</div>
                            <div class="w-full h-1 mt-2 bg-green-400 rounded opacity-50"></div>
                        </div>
                        <div class="metric-card rounded-xl p-4 text-center hover-lift" data-aos="zoom-in"
                            data-aos-delay="300">
                            <div class="text-2xl font-bold text-purple-400" id="room-temp">24°C</div>
                            <div class="text-sm text-gray-400">Room Temp</div>
                            <div class="progress-bar w-full h-1 mt-2">
                                <div class="progress-fill bg-gradient-to-r from-blue-400 to-purple-400"
                                    style="width: 75%"></div>
                            </div>
                        </div>
                        <div class="metric-card rounded-xl p-4 text-center hover-lift" data-aos="zoom-in"
                            data-aos-delay="400">
                            <div class="text-2xl font-bold text-yellow-400" id="sleep-time">2h 15m</div>
                            <div class="text-sm text-gray-400">Sleep Time</div>
                            <div class="progress-bar w-full h-1 mt-2">
                                <div class="progress-fill bg-gradient-to-r from-yellow-400 to-orange-400"
                                    style="width: 60%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Stream Control Panel -->
                    <div class="glass-card rounded-2xl p-6 mb-6" data-aos="fade-up" data-aos-delay="200">
                        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
                            <div class="flex items-center gap-4">
                                <div id="connection-status" class="flex items-center gap-2">
                                    <div id="status-dot" class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                    <span id="status-text" class="text-white font-medium">Connecting...</span>
                                </div>
                                <div class="text-sm text-gray-400">
                                    Protocol: <span class="text-cyan-400 font-medium">WebSocket</span>
                                </div>
                            </div>

                            <div class="flex flex-col lg:flex-row items-start lg:items-center gap-4">
                                <div class="flex items-center gap-4 text-sm text-gray-400">
                                    <div>Clients: <span id="client-count" class="text-cyan-400 font-medium">0</span>
                                    </div>
                                    <div>FPS: <span id="current-fps" class="text-green-400 font-medium">0</span></div>
                                    <div>Quality: <span id="current-quality"
                                            class="text-yellow-400 font-medium">80</span>%</div>
                                </div>

                                <div class="flex items-center gap-2">
                                    <label class="text-sm text-gray-400">Quality:</label>
                                    <input type="range" id="quality-slider" min="30" max="100" value="80" step="10"
                                        class="w-20 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                    <span id="quality-value" class="text-sm text-white">80%</span>
                                    <button id="apply-quality"
                                        class="neon-button px-3 py-1 rounded text-xs font-medium hover-lift">Apply</button>
                                </div>

                                <div class="flex items-center gap-2">
                                    <button id="pause-resume"
                                        class="control-btn px-3 py-1 rounded-full text-sm hover-lift">
                                        <i class="fas fa-pause"></i> Pause
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Video Container -->
                    <div class="video-container rounded-2xl aspect-video relative group" data-aos="zoom-in"
                        data-aos-delay="300">
                        <!-- Streaming Disabled Overlay -->
                        <div id="streaming-disabled-overlay"
                            class="absolute inset-0 bg-gray-900 bg-opacity-95 rounded-2xl flex items-center justify-center z-20"
                            style="display: none;">
                            <div class="text-center p-8" data-aos="fade-up">
                                <div class="text-6xl mb-4">
                                    <i class="fas fa-video-slash text-red-400"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Camera Offline</h3>
                                <p class="text-gray-300 mb-4">Your streaming access has been disabled by an
                                    administrator.</p>
                                <div
                                    class="bg-red-500 bg-opacity-20 border border-red-400 text-red-300 px-4 py-2 rounded-lg">
                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                    Contact your administrator to restore access
                                </div>
                            </div>
                        </div>

                        <img id="video-stream" alt="Live AI Baby Monitor Stream"
                            class="w-full h-full object-cover rounded-2xl transition-all duration-500"
                            src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" />

                        <!-- Enhanced Stream Info Overlay -->
                        <div class="absolute top-4 right-4 flex gap-2">
                            <div id="live-status"
                                class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 hover-lift"
                                style="display: none;">
                                <div id="live-indicator" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                                <span class="text-red-400 font-medium">LIVE</span>
                            </div>
                            <div id="ai-status"
                                class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 hover-lift"
                                style="display: none;">
                                <i class="fas fa-robot text-cyan-400"></i>
                                <span class="text-cyan-400 font-medium">AI Active</span>
                            </div>
                            <div class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 hover-lift">
                                <i class="fas fa-wifi text-green-400"></i>
                                <span class="text-green-400 font-medium" id="stream-fps">-- FPS</span>
                            </div>
                            <div id="sleep-status-indicator"
                                class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 hover-lift">
                                <i id="sleep-status-icon" class="fas fa-moon text-gray-400"></i>
                                <span id="sleep-status-text" class="text-gray-400 font-medium">--</span>
                            </div>
                        </div>

                        <!-- Enhanced Controls Overlay -->
                        <div class="absolute inset-0 control-overlay rounded-2xl">
                            <div class="absolute bottom-6 left-6 flex gap-3">
                                <button class="control-btn p-3 rounded-full hover-lift" onclick="takeSnapshot()"
                                    title="Snapshot">
                                    <i class="fas fa-camera text-white"></i>
                                </button>
                                <button class="control-btn p-3 rounded-full hover-lift" onclick="toggleFullscreen()"
                                    title="Fullscreen">
                                    <i class="fas fa-expand text-white"></i>
                                </button>
                                <button id="clear-child-btn" class="control-btn p-3 rounded-full hover-lift"
                                    onclick="clearChildSelection()" title="Clear Child Selection">
                                    <i class="fas fa-times text-white"></i>
                                </button>
                            </div>

                            <div class="absolute bottom-6 right-6">
                                <div id="child-status"
                                    class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 mb-2 hover-lift"
                                    style="display: none;">
                                    <i class="fas fa-child text-green-400"></i>
                                    <span class="text-green-400 font-medium">Child: <span id="child-id">--</span></span>
                                </div>
                                <div
                                    class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 mb-2 hover-lift">
                                    <i class="fas fa-mouse-pointer text-cyan-400"></i>
                                    <span class="text-cyan-400 font-medium">Click to Select Child</span>
                                </div>
                                <div
                                    class="glass-card px-3 py-1 rounded-full text-sm flex items-center gap-2 hover-lift">
                                    <i class="fas fa-keyboard text-yellow-400"></i>
                                    <span class="text-yellow-400 font-medium">Press H for shortcuts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Sidebar -->
            <div class="lg:col-span-1">
                <div class="sticky top-28 space-y-6 scrollbar-hide max-h-screen overflow-y-auto">
                    <!-- Enhanced AI Features -->
                    <div class="glass-card rounded-2xl p-6 hover-lift" data-aos="fade-left" data-aos-delay="100">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                            <i class="fas fa-magic text-cyan-400"></i>
                            AI Features
                        </h3>
                        <div class="space-y-4">
                            <div class="feature-card rounded-xl p-4" data-aos="fade-left" data-aos-delay="200">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-eye text-green-400"></i>
                                    <span class="font-semibold">Child Detection</span>
                                </div>
                                <p class="text-sm text-gray-400">YOLOv8 + DeepSORT tracking</p>
                                <div class="progress-bar w-full h-1 mt-2">
                                    <div class="progress-fill bg-gradient-to-r from-green-400 to-emerald-400"
                                        style="width: 95%"></div>
                                </div>
                            </div>
                            <div class="feature-card rounded-xl p-4" data-aos="fade-left" data-aos-delay="300">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-bed text-blue-400"></i>
                                    <span class="font-semibold">Sleep Analysis</span>
                                </div>
                                <p class="text-sm text-gray-400">Real-time sleep monitoring</p>
                                <div class="progress-bar w-full h-1 mt-2">
                                    <div class="progress-fill bg-gradient-to-r from-blue-400 to-indigo-400"
                                        style="width: 87%"></div>
                                </div>
                            </div>
                            <div class="feature-card rounded-xl p-4" data-aos="fade-left" data-aos-delay="400">
                                <div class="flex items-center gap-3 mb-2">
                                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                                    <span class="font-semibold">Safety Alerts</span>
                                </div>
                                <p class="text-sm text-gray-400">Fall & zone breach detection</p>
                                <div class="progress-bar w-full h-1 mt-2">
                                    <div class="progress-fill bg-gradient-to-r from-red-400 to-pink-400"
                                        style="width: 92%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if current_user.is_admin %}
                    <!-- Enhanced Active Viewers (Admin Only) -->
                    <div class="glass-card rounded-2xl p-6 hover-lift" id="active-viewers-card" data-aos="fade-left"
                        data-aos-delay="200">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                            <i class="fas fa-users text-purple-400"></i>
                            Active Viewers
                            <span id="active-count-badge"
                                class="ml-2 bg-purple-500 bg-opacity-20 text-purple-400 text-xs font-medium px-2 py-1 rounded-full border border-purple-400 animate-pulse">0</span>
                        </h3>
                        <div id="active-viewers-list" class="space-y-3">
                            <div class="text-center text-gray-400 text-sm py-4">
                                <div class="loading-spinner mx-auto mb-2"></div>
                                <i class="fas fa-user-clock text-2xl mb-2"></i>
                                <p>No active viewers</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Enhanced System Status -->
                    <div class="glass-card rounded-2xl p-6 hover-lift" data-aos="fade-left" data-aos-delay="300">
                        <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                            <i class="fas fa-heartbeat text-pink-400"></i>
                            System Status
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">CPU Usage</span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar w-20 h-2">
                                        <div class="progress-fill bg-gradient-to-r from-green-400 to-yellow-400"
                                            id="cpu-bar" style="width: 75%"></div>
                                    </div>
                                    <span class="text-sm text-green-400" id="cpu-value">75%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Memory</span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar w-20 h-2">
                                        <div class="progress-fill bg-gradient-to-r from-blue-400 to-purple-400"
                                            id="memory-bar" style="width: 50%"></div>
                                    </div>
                                    <span class="text-sm text-blue-400" id="memory-value">50%</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Network</span>
                                <div class="flex items-center gap-2">
                                    <div class="progress-bar w-20 h-2">
                                        <div class="progress-fill bg-gradient-to-r from-cyan-400 to-blue-400"
                                            id="network-bar" style="width: 80%"></div>
                                    </div>
                                    <span class="text-sm text-cyan-400" id="network-value">80%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Footer -->
                    <div class="glass-card rounded-2xl p-4 text-center hover-lift" data-aos="fade-left"
                        data-aos-delay="500">
                        <div class="text-sm text-gray-400 flex items-center justify-center gap-2">
                            <span>Built with</span>
                            <i class="fas fa-heart text-red-400 animate-pulse"></i>
                            <span>by</span>
                            <a href="https://github.com/codeperfectplus"
                                class="text-cyan-400 hover:text-cyan-300 font-medium transition-colors">CodePerfectPlus</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Keyboard Shortcuts Help Modal -->
    <div id="shortcuts-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50"
        style="display: none;">
        <div class="glass-card rounded-2xl p-8 max-w-lg w-full mx-4 hover-lift" data-aos="zoom-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                    <i class="fas fa-keyboard text-cyan-400"></i>
                    Keyboard Shortcuts
                </h3>
                <button onclick="toggleShortcutsHelp()"
                    class="text-gray-400 hover:text-white text-2xl transition-colors hover-lift">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-3">
                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">Q</kbd>
                        <span class="text-white font-medium">Quality Toggle</span>
                    </div>
                    <span class="text-gray-400 text-sm">Switch between high/low quality</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">P</kbd>
                        <span class="text-white font-medium">Pause/Resume</span>
                    </div>
                    <span class="text-gray-400 text-sm">Toggle stream pause</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">S</kbd>
                        <span class="text-white font-medium">Snapshot</span>
                    </div>
                    <span class="text-gray-400 text-sm">Capture instant photo</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">R</kbd>
                        <span class="text-white font-medium">Raw/Annotated</span>
                    </div>
                    <span class="text-gray-400 text-sm">Toggle recording mode</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">C</kbd>
                        <span class="text-white font-medium">Clear Selection</span>
                    </div>
                    <span class="text-gray-400 text-sm">Reset child selection</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">Z</kbd>
                        <span class="text-white font-medium">Sleep Detection</span>
                    </div>
                    <span class="text-gray-400 text-sm">Toggle sleep monitoring</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">F</kbd>
                        <span class="text-white font-medium">Fullscreen</span>
                    </div>
                    <span class="text-gray-400 text-sm">Toggle fullscreen mode</span>
                </div>

                <div
                    class="flex justify-between items-center py-2 px-4 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition-all">
                    <div class="flex items-center gap-3">
                        <kbd
                            class="px-2 py-1 bg-gradient-to-r from-gray-700 to-gray-600 text-white rounded text-sm font-mono shadow-lg">H</kbd>
                        <span class="text-white font-medium">Help</span>
                    </div>
                    <span class="text-gray-400 text-sm">Show/hide this help panel</span>
                </div>
            </div>

            <div class="mt-6 p-4 bg-cyan-500 bg-opacity-10 border border-cyan-500 border-opacity-20 rounded-lg">
                <div class="flex items-center gap-2 text-cyan-400 mb-2">
                    <i class="fas fa-info-circle"></i>
                    <span class="font-medium">Pro Tip</span>
                </div>
                <p class="text-sm text-gray-300">Click anywhere on the video to manually select a child for tracking.
                    Use the clear button to reset selection.</p>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
   <script src="{{ url_for('static', filename='js/particle_animation.js') }}"></script>

    <script>
        // Global configuration
        const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};
        const initialStreamingEnabled = {{ current_user.streaming_enabled| lower if current_user.is_authenticated else 'true' }};
        let streamingEnabled = initialStreamingEnabled;

        // WebSocket connection
        const socket = io();
        let streamActive = true;
        let frameCount = 0;
        let lastFrameTime = Date.now();

        // DOM elements
        const videoStream = document.getElementById('video-stream');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const clientCount = document.getElementById('client-count');
        const currentFps = document.getElementById('current-fps');
        const currentQuality = document.getElementById('current-quality');
        const streamFps = document.getElementById('stream-fps');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const applyQuality = document.getElementById('apply-quality');
        const pauseResumeBtn = document.getElementById('pause-resume');
        const liveIndicator = document.getElementById('live-indicator');
        const streamingDisabledOverlay = document.getElementById('streaming-disabled-overlay');

        // Check streaming permissions on page load
        function checkStreamingPermissions() {
            if (!streamingEnabled) {
                streamingDisabledOverlay.style.display = 'flex';
                videoStream.style.display = 'none';
                // Disable streaming controls
                if (pauseResumeBtn) pauseResumeBtn.disabled = true;
                if (qualitySlider) qualitySlider.disabled = true;
                if (applyQuality) applyQuality.disabled = true;
            } else {
                streamingDisabledOverlay.style.display = 'none';
                videoStream.style.display = 'block';
                // Enable streaming controls
                if (pauseResumeBtn) pauseResumeBtn.disabled = false;
                if (qualitySlider) qualitySlider.disabled = false;
                if (applyQuality) applyQuality.disabled = false;
            }
        }

        // Call check on page load
        checkStreamingPermissions();

        // WebSocket event handlers
        socket.on('connect', function () {
            console.log('Connected to WebSocket');
            statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
            statusText.textContent = 'Connected';
            liveIndicator.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';

            // Show live and AI status indicators
            document.getElementById('live-status').style.display = 'flex';
            document.getElementById('ai-status').style.display = 'flex';

            showNotification('WebSocket connected successfully!', 'success');

            // Join admin room for active users updates (admin only)
            joinAdminRoom();
        });

        socket.on('disconnect', function () {
            console.log('Disconnected from WebSocket');
            statusDot.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
            statusText.textContent = 'Disconnected';
            liveIndicator.className = 'w-2 h-2 bg-red-500 rounded-full animate-pulse';

            // Hide live and AI status indicators when disconnected
            document.getElementById('live-status').style.display = 'none';
            document.getElementById('ai-status').style.display = 'none';

            streamActive = false;
            showNotification('WebSocket disconnected', 'error');
        });

        socket.on('connection_status', function (data) {
            clientCount.textContent = data.client_count;
            console.log('Connection status:', data);
        });

        socket.on('video_frame', function (data) {
            if (streamActive && streamingEnabled && data.frame) {
                videoStream.src = 'data:image/jpeg;base64,' + data.frame;

                // Calculate and display FPS
                frameCount++;
                const now = Date.now();
                if (now - lastFrameTime >= 1000) {
                    const fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
                    currentFps.textContent = fps;
                    streamFps.textContent = fps + ' FPS';
                    frameCount = 0;
                    lastFrameTime = now;
                }
            }
        });

        socket.on('quality_changed', function (data) {
            currentQuality.textContent = data.quality;
            qualitySlider.value = data.quality;
            qualityValue.textContent = data.quality + '%';
            showNotification(`Quality updated to ${data.quality}%`, 'success');
        });

        // Handle streaming permission changes
        socket.on('streaming_permission_changed', function (data) {
            // If message has target_user_id, check if it's for current user
            if (data.target_user_id && data.target_user_id !== currentUserId) {
                return; // Not for this user
            }

            console.log('[DEBUG] Received streaming permission change:', data);
            streamingEnabled = data.streaming_enabled;
            checkStreamingPermissions();

            if (data.streaming_enabled) {
                showNotification('Your streaming access has been enabled!', 'success');
            } else {
                showNotification('Your streaming access has been disabled by an administrator.', 'error');
            }
        });

        // Child selection WebSocket handlers
        socket.on('child_select_response', function (data) {
            if (data.success) {
                showNotification(data.message, 'success');
                requestChildStatus(); // Update child status
            }
        });

        socket.on('child_select_error', function (data) {
            showNotification(`Child selection failed: ${data.message}`, 'error');
        });

        socket.on('child_clear_response', function (data) {
            if (data.success) {
                showNotification('Child selection cleared', 'success');
                updateChildStatus(null); // Clear child status display
            }
        });

        socket.on('child_clear_error', function (data) {
            showNotification(`Failed to clear selection: ${data.message}`, 'error');
        });

        socket.on('child_status', function (data) {
            updateChildStatus(data);
        });

        socket.on('child_status_error', function (data) {
            console.error('Child status error:', data.message);
        });

        // Active users WebSocket handlers (admin only)
        socket.on('active_users_update', function (data) {
            if (document.getElementById('active-viewers-card')) {
                updateActiveViewers(data.active_users, data.count);
            }
        });

        // Control event handlers
        qualitySlider.addEventListener('input', function () {
            qualityValue.textContent = this.value + '%';
        });

        applyQuality.addEventListener('click', function () {
            const quality = parseInt(qualitySlider.value);
            socket.emit('request_quality_change', { quality: quality });
            showNotification('Applying quality change...', 'info');
        });

        pauseResumeBtn.addEventListener('click', function () {
            streamActive = !streamActive;
            const icon = this.querySelector('i');
            const text = this.querySelector('span') || this;

            if (streamActive) {
                icon.className = 'fas fa-pause';
                text.innerHTML = '<i class="fas fa-pause"></i> Pause';
                liveIndicator.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                showNotification('Stream resumed', 'success');
            } else {
                icon.className = 'fas fa-play';
                text.innerHTML = '<i class="fas fa-play"></i> Resume';
                liveIndicator.className = 'w-2 h-2 bg-gray-500 rounded-full';
                videoStream.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                showNotification('Stream paused', 'warning');
            }
        });

        // Fullscreen functionality
        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Snapshot functionality
        function takeSnapshot() {
            fetch('/snapshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Snapshot saved successfully!', 'success');
                    } else {
                        showNotification(data.message || 'Failed to save snapshot', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error taking snapshot:', error);
                    showNotification('Failed to save snapshot', 'error');
                });
        }

        // Child selection functions
        function clearChildSelection() {
            socket.emit('child_clear');
        }

        function updateChildStatus(data) {
            const childStatus = document.getElementById('child-status');
            const childIdSpan = document.getElementById('child-id');

            if (data && data.selected) {
                childIdSpan.textContent = `ID ${data.child_id} (${Math.round(data.confidence * 100)}%)`;
                childStatus.style.display = 'flex';
            } else {
                childStatus.style.display = 'none';
            }
        }

        function requestChildStatus() {
            socket.emit('child_status_request');
        }

        // Add click-to-select functionality to video
        videoStream.addEventListener('click', function (event) {
            if (!streamActive) return;

            const rect = this.getBoundingClientRect();
            const scaleX = this.naturalWidth / rect.width;
            const scaleY = this.naturalHeight / rect.height;

            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);

            console.log(`Selecting child at coordinates: ${x}, ${y}`);
            socket.emit('child_select', { x: x, y: y });

            // Visual feedback - show click effect
            const clickEffect = document.createElement('div');
            clickEffect.className = 'absolute w-4 h-4 border-2 border-cyan-400 rounded-full animate-ping pointer-events-none';
            clickEffect.style.left = (event.clientX - rect.left - 8) + 'px';
            clickEffect.style.top = (event.clientY - rect.top - 8) + 'px';

            this.parentElement.appendChild(clickEffect);
            setTimeout(() => clickEffect.remove(), 1000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

            switch (event.key.toLowerCase()) {
                case 's':
                    event.preventDefault();
                    takeSnapshot();
                    showNotification('Snapshot taken!', 'success');
                    break;
                case 'p':
                    event.preventDefault();
                    pauseResumeBtn.click();
                    break;
                case 'f':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                case 'q':
                    event.preventDefault();
                    // Toggle quality between high and low
                    const currentQual = parseInt(qualitySlider.value);
                    qualitySlider.value = currentQual > 50 ? 30 : 100;
                    qualityValue.textContent = qualitySlider.value + '%';
                    applyQuality.click();
                    showNotification(`Quality switched to ${qualitySlider.value}%`, 'info');
                    break;
                case 'c':
                    event.preventDefault();
                    clearChildSelection();
                    showNotification('Child selection cleared', 'info');
                    break;
                case 'r':
                    event.preventDefault();
                    toggleRecordingMode();
                    break;
                case 'z':
                    event.preventDefault();
                    toggleSleepDetection();
                    break;
                case 'h':
                    event.preventDefault();
                    toggleShortcutsHelp();
                    break;
            }
        });

        // Show notification function
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-28 right-6 glass-card rounded-lg p-4 z-50 transform translate-x-full transition-transform duration-300`;

            const colors = {
                success: 'text-green-400 border-green-400/20',
                info: 'text-blue-400 border-blue-400/20',
                warning: 'text-yellow-400 border-yellow-400/20',
                error: 'text-red-400 border-red-400/20'
            };

            const icons = {
                success: 'fa-check-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };

            notification.className += ` ${colors[type]}`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${icons[type]}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add some interactive feedback
        document.querySelectorAll('.control-btn, .neon-button').forEach(btn => {
            btn.addEventListener('click', function () {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });

        // Update metrics with streaming info
        function updateMetrics() {
            fetch('/metrics')
                .then(response => response.json())
                .then(data => {
                    // Live Metrics
                    document.getElementById('detection-rate').textContent = data.detection_rate + '%';

                    // Update sleep state with appropriate color
                    const sleepStateElement = document.getElementById('sleep-state');
                    sleepStateElement.textContent = data.sleep_state;

                    // Update sleep status indicator in video overlay
                    const sleepStatusIcon = document.getElementById('sleep-status-icon');
                    const sleepStatusText = document.getElementById('sleep-status-text');

                    if (sleepStatusIcon && sleepStatusText) {
                        sleepStatusText.textContent = data.sleep_state;

                        // Remove all existing classes
                        sleepStatusIcon.className = 'fas';
                        sleepStatusText.className = 'font-medium';

                        // Apply appropriate icon and color based on state
                        switch (data.sleep_state) {
                            case 'Sleep':
                            case 'SLEEPING':
                                sleepStatusIcon.className += ' fa-bed text-blue-400';
                                sleepStatusText.className += ' text-blue-400';
                                break;
                            case 'Awake':
                            case 'AWAKE':
                            case 'ACTIVE':
                                sleepStatusIcon.className += ' fa-eye text-green-400';
                                sleepStatusText.className += ' text-green-400';
                                break;
                            case 'No child':
                            case 'NO_CHILD':
                                sleepStatusIcon.className += ' fa-user-slash text-gray-400';
                                sleepStatusText.className += ' text-gray-400';
                                sleepStatusText.textContent = 'No Child';
                                break;
                            case 'Disabled':
                            case 'DISABLED':
                                sleepStatusIcon.className += ' fa-moon-o text-red-400';
                                sleepStatusText.className += ' text-red-400';
                                break;
                            default:
                                sleepStatusIcon.className += ' fa-question text-orange-400';
                                sleepStatusText.className += ' text-orange-400';
                                break;
                        }
                    }

                    // Remove all color classes from main sleep state element
                    sleepStateElement.classList.remove('text-green-400', 'text-blue-400', 'text-gray-400', 'text-orange-400', 'text-red-400');

                    // Apply color based on state
                    switch (data.sleep_state) {
                        case 'Sleep':
                            sleepStateElement.classList.add('text-green-400');
                            break;
                        case 'Awake':
                            sleepStateElement.classList.add('text-blue-400');
                            break;
                        case 'No child':
                            sleepStateElement.classList.add('text-gray-400');
                            break;
                        case 'Disabled':
                            sleepStateElement.classList.add('text-red-400');
                            break;
                        default:
                            sleepStateElement.classList.add('text-orange-400');
                            break;
                    }

                    document.getElementById('room-temp').textContent = data.room_temp + '°C';
                    document.getElementById('sleep-time').textContent = data.sleep_time;

                    // Update streaming metrics if available
                    if (data.streaming) {
                        currentQuality.textContent = data.streaming.adaptive_quality;
                        if (!streamActive || frameCount === 0) {
                            // Update server-side FPS if client isn't calculating
                            streamFps.textContent = data.streaming.adaptive_fps + ' FPS';
                        }
                    }

                    // System Status Bars
                    const cpuBar = document.getElementById('cpu-bar');
                    const memoryBar = document.getElementById('memory-bar');
                    const networkBar = document.getElementById('network-bar');
                    if (cpuBar) {
                        cpuBar.style.width = Math.max(10, Math.min(100, data.cpu)) + '%';
                        document.getElementById('cpu-value').textContent = Math.round(data.cpu) + '%';
                    }
                    if (memoryBar) {
                        memoryBar.style.width = Math.max(10, Math.min(100, data.memory)) + '%';
                        document.getElementById('memory-value').textContent = Math.round(data.memory) + '%';
                    }
                    if (networkBar) {
                        networkBar.style.width = Math.max(10, Math.min(100, data.network)) + '%';
                        document.getElementById('network-value').textContent = Math.round(data.network) + '%';
                    }
                })
                .catch(error => console.error('Error updating metrics:', error));
        }

        setInterval(updateMetrics, 3000);
        window.onload = updateMetrics;

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');

                if (dropdown.classList.contains('show')) {
                    loadNotificationsList();
                }
            }
        }

        // Toggle user dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside (extended to handle user menu)
        document.addEventListener('click', function (event) {
            const notificationContainer = document.querySelector('.notifications-container');
            const userContainer = document.querySelector('.user-menu');

            if (notificationContainer && !notificationContainer.contains(event.target)) {
                const dropdown = document.getElementById('notifications-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }

            if (userContainer && !userContainer.contains(event.target)) {
                const dropdown = document.getElementById('user-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Load notifications list
        function loadNotificationsList() {
            fetch('/notifications')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('notifications-list');
                    const badge = document.getElementById('notification-badge');

                    if (list && badge && data.notifications && data.notifications.length > 0) {
                        // Update badge
                        badge.textContent = data.notifications.length;
                        badge.style.display = data.notifications.length > 0 ? 'flex' : 'none';

                        // Populate list
                        list.innerHTML = data.notifications
                            .slice(-20) // Last 20 notifications
                            .reverse() // Most recent first
                            .map(notification => {
                                const time = new Date(notification.timestamp).toLocaleTimeString();
                                return `
                                    <div class="notification-item notification-${notification.type}">
                                        <div class="notification-title">${notification.title}</div>
                                        <div class="notification-message">${notification.message}</div>
                                        <div class="notification-time">${time}</div>
                                    </div>
                                `;
                            }).join('');
                    } else if (list) {
                        if (badge) badge.style.display = 'none';
                        list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">No notifications yet</div>';
                    }
                })
                .catch(error => console.error('Error loading notifications:', error));
        }

        // Auto-start stream when page loads
        window.addEventListener('load', function () {
            console.log('Page loaded, WebSocket should connect automatically');
            // Show keyboard shortcuts hint
            setTimeout(() => {
                showNotification('Press H for shortcuts help. Quick keys: S=Snapshot, P=Pause, F=Fullscreen', 'info');
            }, 2000);

            // Request initial child status
            setTimeout(() => {
                requestChildStatus();
            }, 1000);
        });

        // Periodically update child status
        setInterval(requestChildStatus, 2000);

        // Toggle shortcuts help modal
        function toggleShortcutsHelp() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        // Toggle sleep detection
        function toggleSleepDetection() {
            socket.emit('toggle_sleep_detection');
        }

        // Toggle recording mode (raw/annotated)
        function toggleRecordingMode() {
            socket.emit('toggle_recording_mode');
        }

        // Handle sleep detection WebSocket events
        socket.on('sleep_detection_toggled', function (data) {
            if (data.success) {
                const status = data.enabled ? 'enabled' : 'disabled';
                showNotification(`Sleep detection ${status}`, data.enabled ? 'success' : 'warning');

                // Update sleep status indicator immediately
                const sleepStatusIcon = document.getElementById('sleep-status-icon');
                const sleepStatusText = document.getElementById('sleep-status-text');

                if (!data.enabled) {
                    // If disabled, show disabled status
                    sleepStatusIcon.className = 'fas fa-moon-o text-red-400';
                    sleepStatusText.className = 'font-medium text-red-400';
                    sleepStatusText.textContent = 'Disabled';
                } else {
                    // If enabled, it will be updated by the next metrics call
                    sleepStatusIcon.className = 'fas fa-moon text-blue-400';
                    sleepStatusText.className = 'font-medium text-blue-400';
                    sleepStatusText.textContent = 'Enabled';
                }
            }
        });

        socket.on('sleep_detection_error', function (data) {
            showNotification('Failed to toggle sleep detection: ' + data.message, 'error');
        });

        // Handle recording mode WebSocket events
        socket.on('recording_mode_toggled', function (data) {
            if (data.success) {
                const mode = data.annotated ? 'annotated (with AI overlay)' : 'raw (clean video)';
                showNotification(`Recording mode: ${mode}`, 'info');
            }
        });

        socket.on('recording_mode_error', function (data) {
            showNotification('Failed to toggle recording mode: ' + data.message, 'error');
        });

        // Close modal when clicking outside
        document.getElementById('shortcuts-modal').addEventListener('click', function (event) {
            if (event.target === this) {
                toggleShortcutsHelp();
            }
        });
    </script>

    <script>
        // Update the existing fetchNotifications to also update the badge
        const originalFetchNotifications = fetchNotifications;
        fetchNotifications = function () {
            originalFetchNotifications();

            // Also update badge count
            fetch('/notifications')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notification-badge');
                    if (data.notifications && data.notifications.length > 0) {
                        badge.textContent = data.notifications.length;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error updating badge:', error));
        };

        // Poll for notifications every 2 seconds
        setInterval(fetchNotifications, 2000);

        // Active viewers functions (admin only)
        function joinAdminRoom() {
            if (document.getElementById('active-viewers-card')) {
                socket.emit('join_admin_room');
            }
        }

        function updateActiveViewers(activeUsers, count) {
            const countBadge = document.getElementById('active-count-badge');
            const viewersList = document.getElementById('active-viewers-list');

            if (!countBadge || !viewersList) return;

            // Update count badge
            countBadge.textContent = count;

            // Clear existing list
            viewersList.innerHTML = '';

            if (activeUsers.length === 0) {
                viewersList.innerHTML = `
                    <div class="text-center text-gray-400 text-sm py-4">
                        <i class="fas fa-user-clock text-2xl mb-2"></i>
                        <p>No active viewers</p>
                    </div>
                `;
                return;
            }

            // Add each active user
            activeUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'feature-card rounded-xl p-3 flex items-center gap-3';

                const relationshipIcons = {
                    'Father': 'fa-male',
                    'Mother': 'fa-female',
                    'Guardian': 'fa-shield-alt',
                    'Grandparent': 'fa-heart',
                    'Babysitter': 'fa-child',
                    'Other': 'fa-user'
                };

                const relationshipColors = {
                    'Father': 'text-blue-400',
                    'Mother': 'text-pink-400',
                    'Guardian': 'text-green-400',
                    'Grandparent': 'text-purple-400',
                    'Babysitter': 'text-yellow-400',
                    'Other': 'text-gray-400'
                };

                const icon = relationshipIcons[user.relationship] || 'fa-user';
                const color = relationshipColors[user.relationship] || 'text-gray-400';
                const isCurrentUser = user.user_id == currentUserId;

                userElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-white font-medium text-xs">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-white text-sm">${user.username}</span>
                            ${isCurrentUser ? '<span class="text-xs bg-cyan-500 bg-opacity-20 text-cyan-400 px-2 py-0.5 rounded-full border border-cyan-400">You</span>' : ''}
                            ${user.is_admin ? '<span class="text-xs bg-purple-500 bg-opacity-20 text-purple-400 px-2 py-0.5 rounded-full border border-purple-400"><i class="fas fa-crown mr-1"></i>Admin</span>' : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <i class="fas ${icon} ${color} text-xs"></i>
                            <span class="text-xs ${color}">${user.relationship}</span>
                            <span class="text-xs text-gray-500">•</span>
                            <span class="text-xs text-gray-400">Active now</span>
                        </div>
                    </div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                `;

                viewersList.appendChild(userElement);
            });
        }

        // Send heartbeat every 30 seconds to keep user active
        setInterval(function () {
            if (socket.connected) {
                socket.emit('user_heartbeat');
            }
        }, 30000);

        // Clear all notifications function
        function clearAllNotifications() {
            fetch('/notifications/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All notifications cleared', 'success');
                        loadNotificationsList();
                    } else {
                        showNotification('Failed to clear notifications', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error clearing notifications:', error);
                    showNotification('Failed to clear notifications', 'error');
                });
        }

        // Update notification badge styles
        const notificationBadgeStyles = `
            .notification-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(45deg, #ef4444, #dc2626);
                color: white;
                font-size: 10px;
                font-weight: bold;
                padding: 2px 6px;
                border-radius: 12px;
                min-width: 18px;
                height: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: badge-pulse 2s infinite;
            }
            
            @keyframes badge-pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            .notification-title {
                font-weight: bold;
                margin-bottom: 2px;
                color: #ffffff;
            }
            
            .notification-message {
                font-size: 12px;
                color: #d1d5db;
                margin-bottom: 4px;
                line-height: 1.3;
            }
            
            .notification-time {
                font-size: 10px;
                color: #9ca3af;
            }
            
            .notification-success {
                border-left: 3px solid #10b981;
                background: rgba(16, 185, 129, 0.05);
            }
            
            .notification-error {
                border-left: 3px solid #ef4444;
                background: rgba(239, 68, 68, 0.05);
            }
            
            .notification-warning {
                border-left: 3px solid #f59e0b;
                background: rgba(245, 158, 11, 0.05);
            }
            
            .notification-info {
                border-left: 3px solid #3b82f6;
                background: rgba(59, 130, 246, 0.05);
            }
        `;

        // Inject notification styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = notificationBadgeStyles;
        document.head.appendChild(styleSheet);

        // Initialize notification badge on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadNotificationsList();
        });

        // Enhanced error handling for WebSocket events
        socket.on('error', function (error) {
            console.error('WebSocket error:', error);
            showNotification('Connection error occurred', 'error');
        });

        socket.on('reconnect', function () {
            showNotification('Reconnected to server', 'success');
            checkStreamingPermissions();
            requestChildStatus();
        });

        socket.on('reconnect_error', function () {
            showNotification('Failed to reconnect to server', 'error');
        });

        // Performance monitoring
        let performanceStats = {
            frameDrops: 0,
            lastFrameTime: 0,
            avgFps: 0,
            fpsHistory: []
        };

        // Monitor video performance
        function updatePerformanceStats(fps) {
            performanceStats.fpsHistory.push(fps);
            if (performanceStats.fpsHistory.length > 10) {
                performanceStats.fpsHistory.shift();
            }

            performanceStats.avgFps = performanceStats.fpsHistory.reduce((a, b) => a + b, 0) / performanceStats.fpsHistory.length;

            // Detect frame drops
            if (fps < performanceStats.avgFps * 0.7) {
                performanceStats.frameDrops++;
            }
        }

        // Auto-adjust quality based on performance
        function autoAdjustQuality() {
            if (performanceStats.frameDrops > 5) {
                const currentQual = parseInt(qualitySlider.value);
                if (currentQual > 30) {
                    qualitySlider.value = Math.max(30, currentQual - 10);
                    qualityValue.textContent = qualitySlider.value + '%';
                    applyQuality.click();
                    showNotification('Quality auto-adjusted due to performance', 'info');
                    performanceStats.frameDrops = 0;
                }
            }
        }

        // Check performance every 30 seconds
        setInterval(autoAdjustQuality, 30000);

        // Enhanced video stream error handling
        videoStream.addEventListener('error', function (e) {
            console.error('Video stream error:', e);
            showNotification('Video stream error occurred', 'error');
        });

        videoStream.addEventListener('loadstart', function () {
            console.log('Video stream loading started');
        });

        videoStream.addEventListener('loadeddata', function () {
            console.log('Video stream data loaded');
        });

        // Keyboard shortcut hints
        const shortcutHints = {
            's': 'Take Snapshot',
            'p': 'Pause/Resume',
            'f': 'Fullscreen',
            'q': 'Toggle Quality',
            'c': 'Clear Child Selection',
            'r': 'Recording Mode',
            'z': 'Sleep Detection',
            'h': 'Help'
        };

        // Show random shortcut hint occasionally
        function showRandomShortcutHint() {
            const shortcuts = Object.keys(shortcutHints);
            const randomKey = shortcuts[Math.floor(Math.random() * shortcuts.length)];
            const hint = shortcutHints[randomKey];
            showNotification(`💡 Tip: Press "${randomKey.toUpperCase()}" to ${hint}`, 'info');
        }

        // Show hint every 5 minutes
        setInterval(showRandomShortcutHint, 300000);

        console.log('🚀 AI Baby Monitor initialized successfully!');
        console.log('📹 Video stream ready');
        console.log('🔌 WebSocket connection established');
        console.log('⌨️ Press H for keyboard shortcuts');

    </script>
</body>

</html>