 <script>
        // Global configuration
        const currentUserId = {{ current_user.id if current_user.is_authenticated else 'null' }};
        const initialStreamingEnabled = {{ current_user.streaming_enabled| lower if current_user.is_authenticated else 'true' }};
        let streamingEnabled = initialStreamingEnabled;

        // WebSocket connection
        const socket = io();
        let streamActive = true;
        let frameCount = 0;
        let lastFrameTime = Date.now();

        // DOM elements
        const videoStream = document.getElementById('video-stream');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const clientCount = document.getElementById('client-count');
        const currentFps = document.getElementById('current-fps');
        const currentQuality = document.getElementById('current-quality');
        const streamFps = document.getElementById('stream-fps');
        const qualitySlider = document.getElementById('quality-slider');
        const qualityValue = document.getElementById('quality-value');
        const applyQuality = document.getElementById('apply-quality');
        const pauseResumeBtn = document.getElementById('pause-resume');
        const liveIndicator = document.getElementById('live-indicator');
        const streamingDisabledOverlay = document.getElementById('streaming-disabled-overlay');

        // Check streaming permissions on page load
        function checkStreamingPermissions() {
            if (!streamingEnabled) {
                streamingDisabledOverlay.style.display = 'flex';
                videoStream.style.display = 'none';
                // Disable streaming controls
                if (pauseResumeBtn) pauseResumeBtn.disabled = true;
                if (qualitySlider) qualitySlider.disabled = true;
                if (applyQuality) applyQuality.disabled = true;
            } else {
                streamingDisabledOverlay.style.display = 'none';
                videoStream.style.display = 'block';
                // Enable streaming controls
                if (pauseResumeBtn) pauseResumeBtn.disabled = false;
                if (qualitySlider) qualitySlider.disabled = false;
                if (applyQuality) applyQuality.disabled = false;
            }
        }

        // Call check on page load
        checkStreamingPermissions();

        // WebSocket event handlers
        socket.on('connect', function () {
            console.log('Connected to WebSocket');
            statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
            statusText.textContent = 'Connected';
            liveIndicator.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';

            // Show live and AI status indicators
            document.getElementById('live-status').style.display = 'flex';
            document.getElementById('ai-status').style.display = 'flex';

            showNotification('WebSocket connected successfully!', 'success');

            // Join admin room for active users updates (admin only)
            joinAdminRoom();
        });

        socket.on('disconnect', function () {
            console.log('Disconnected from WebSocket');
            statusDot.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
            statusText.textContent = 'Disconnected';
            liveIndicator.className = 'w-2 h-2 bg-red-500 rounded-full animate-pulse';

            // Hide live and AI status indicators when disconnected
            document.getElementById('live-status').style.display = 'none';
            document.getElementById('ai-status').style.display = 'none';

            streamActive = false;
            showNotification('WebSocket disconnected', 'error');
        });

        socket.on('connection_status', function (data) {
            clientCount.textContent = data.client_count;
            console.log('Connection status:', data);
        });

        socket.on('video_frame', function (data) {
            if (streamActive && streamingEnabled && data.frame) {
                videoStream.src = 'data:image/jpeg;base64,' + data.frame;

                // Calculate and display FPS
                frameCount++;
                const now = Date.now();
                if (now - lastFrameTime >= 1000) {
                    const fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
                    currentFps.textContent = fps;
                    streamFps.textContent = fps + ' FPS';
                    frameCount = 0;
                    lastFrameTime = now;
                }
            }
        });

        socket.on('quality_changed', function (data) {
            currentQuality.textContent = data.quality;
            qualitySlider.value = data.quality;
            qualityValue.textContent = data.quality + '%';
            showNotification(`Quality updated to ${data.quality}%`, 'success');
        });

        // Handle streaming permission changes
        socket.on('streaming_permission_changed', function (data) {
            // If message has target_user_id, check if it's for current user
            if (data.target_user_id && data.target_user_id !== currentUserId) {
                return; // Not for this user
            }

            console.log('[DEBUG] Received streaming permission change:', data);
            streamingEnabled = data.streaming_enabled;
            checkStreamingPermissions();

            if (data.streaming_enabled) {
                showNotification('Your streaming access has been enabled!', 'success');
            } else {
                showNotification('Your streaming access has been disabled by an administrator.', 'error');
            }
        });

        // Child selection WebSocket handlers
        socket.on('child_select_response', function (data) {
            if (data.success) {
                showNotification(data.message, 'success');
                requestChildStatus(); // Update child status
            }
        });

        socket.on('child_select_error', function (data) {
            showNotification(`Child selection failed: ${data.message}`, 'error');
        });

        socket.on('child_clear_response', function (data) {
            if (data.success) {
                showNotification('Child selection cleared', 'success');
                updateChildStatus(null); // Clear child status display
            }
        });

        socket.on('child_clear_error', function (data) {
            showNotification(`Failed to clear selection: ${data.message}`, 'error');
        });

        socket.on('child_status', function (data) {
            updateChildStatus(data);
        });

        socket.on('child_status_error', function (data) {
            console.error('Child status error:', data.message);
        });

        // Active users WebSocket handlers (admin only)
        socket.on('active_users_update', function (data) {
            if (document.getElementById('active-viewers-card')) {
                updateActiveViewers(data.active_users, data.count);
            }
        });

        // Control event handlers
        qualitySlider.addEventListener('input', function () {
            qualityValue.textContent = this.value + '%';
        });

        applyQuality.addEventListener('click', function () {
            const quality = parseInt(qualitySlider.value);
            socket.emit('request_quality_change', { quality: quality });
            showNotification('Applying quality change...', 'info');
        });

        pauseResumeBtn.addEventListener('click', function () {
            streamActive = !streamActive;
            const icon = this.querySelector('i');
            const text = this.querySelector('span') || this;

            if (streamActive) {
                icon.className = 'fas fa-pause';
                text.innerHTML = '<i class="fas fa-pause"></i> Pause';
                liveIndicator.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                showNotification('Stream resumed', 'success');
            } else {
                icon.className = 'fas fa-play';
                text.innerHTML = '<i class="fas fa-play"></i> Resume';
                liveIndicator.className = 'w-2 h-2 bg-gray-500 rounded-full';
                videoStream.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                showNotification('Stream paused', 'warning');
            }
        });

        // Fullscreen functionality
        function toggleFullscreen() {
            const videoContainer = document.querySelector('.video-container');
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        // Snapshot functionality
        function takeSnapshot() {
            fetch('/snapshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Snapshot saved successfully!', 'success');
                    } else {
                        showNotification(data.message || 'Failed to save snapshot', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error taking snapshot:', error);
                    showNotification('Failed to save snapshot', 'error');
                });
        }

        // Child selection functions
        function clearChildSelection() {
            socket.emit('child_clear');
        }

        function updateChildStatus(data) {
            const childStatus = document.getElementById('child-status');
            const childIdSpan = document.getElementById('child-id');

            if (data && data.selected) {
                childIdSpan.textContent = `ID ${data.child_id} (${Math.round(data.confidence * 100)}%)`;
                childStatus.style.display = 'flex';
            } else {
                childStatus.style.display = 'none';
            }
        }

        function requestChildStatus() {
            socket.emit('child_status_request');
        }

        // Add click-to-select functionality to video
        videoStream.addEventListener('click', function (event) {
            if (!streamActive) return;

            const rect = this.getBoundingClientRect();
            const scaleX = this.naturalWidth / rect.width;
            const scaleY = this.naturalHeight / rect.height;

            const x = Math.round((event.clientX - rect.left) * scaleX);
            const y = Math.round((event.clientY - rect.top) * scaleY);

            console.log(`Selecting child at coordinates: ${x}, ${y}`);
            socket.emit('child_select', { x: x, y: y });

            // Visual feedback - show click effect
            const clickEffect = document.createElement('div');
            clickEffect.className = 'absolute w-4 h-4 border-2 border-cyan-400 rounded-full animate-ping pointer-events-none';
            clickEffect.style.left = (event.clientX - rect.left - 8) + 'px';
            clickEffect.style.top = (event.clientY - rect.top - 8) + 'px';

            this.parentElement.appendChild(clickEffect);
            setTimeout(() => clickEffect.remove(), 1000);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function (event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;

            switch (event.key.toLowerCase()) {
                case 's':
                    event.preventDefault();
                    takeSnapshot();
                    showNotification('Snapshot taken!', 'success');
                    break;
                case 'p':
                    event.preventDefault();
                    pauseResumeBtn.click();
                    break;
                case 'f':
                    event.preventDefault();
                    toggleFullscreen();
                    break;
                case 'q':
                    event.preventDefault();
                    // Toggle quality between high and low
                    const currentQual = parseInt(qualitySlider.value);
                    qualitySlider.value = currentQual > 50 ? 30 : 100;
                    qualityValue.textContent = qualitySlider.value + '%';
                    applyQuality.click();
                    showNotification(`Quality switched to ${qualitySlider.value}%`, 'info');
                    break;
                case 'c':
                    event.preventDefault();
                    clearChildSelection();
                    showNotification('Child selection cleared', 'info');
                    break;
                case 'r':
                    event.preventDefault();
                    toggleRecordingMode();
                    break;
                case 'z':
                    event.preventDefault();
                    toggleSleepDetection();
                    break;
                case 'h':
                    event.preventDefault();
                    toggleShortcutsHelp();
                    break;
            }
        });

        // Show notification function (make it globally available)
        window.showNotification = function(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-28 right-6 glass-card rounded-lg p-4 z-50 transform translate-x-full transition-transform duration-300`;

            const colors = {
                success: 'text-green-400 border-green-400/20',
                info: 'text-blue-400 border-blue-400/20',
                warning: 'text-yellow-400 border-yellow-400/20',
                error: 'text-red-400 border-red-400/20'
            };

            const icons = {
                success: 'fa-check-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle',
                error: 'fa-times-circle'
            };

            notification.className += ` ${colors[type]}`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas ${icons[type]}"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        };

        // Add some interactive feedback
        document.querySelectorAll('.control-btn, .neon-button').forEach(btn => {
            btn.addEventListener('click', function () {
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });

        // Update metrics with streaming info
        function updateMetrics() {
            fetch('/metrics')
                .then(response => response.json())
                .then(data => {
                    // Live Metrics
                    document.getElementById('detection-rate').textContent = data.detection_rate + '%';

                    // Update sleep state with appropriate color
                    const sleepStateElement = document.getElementById('sleep-state');
                    sleepStateElement.textContent = data.sleep_state;

                    // Update sleep status indicator in video overlay
                    const sleepStatusIcon = document.getElementById('sleep-status-icon');
                    const sleepStatusText = document.getElementById('sleep-status-text');

                    if (sleepStatusIcon && sleepStatusText) {
                        sleepStatusText.textContent = data.sleep_state;

                        // Remove all existing classes
                        sleepStatusIcon.className = 'fas';
                        sleepStatusText.className = 'font-medium';

                        // Apply appropriate icon and color based on state
                        switch (data.sleep_state) {
                            case 'Sleep':
                            case 'SLEEPING':
                                sleepStatusIcon.className += ' fa-bed text-blue-400';
                                sleepStatusText.className += ' text-blue-400';
                                break;
                            case 'Awake':
                            case 'AWAKE':
                            case 'ACTIVE':
                                sleepStatusIcon.className += ' fa-eye text-green-400';
                                sleepStatusText.className += ' text-green-400';
                                break;
                            case 'No child':
                            case 'NO_CHILD':
                                sleepStatusIcon.className += ' fa-user-slash text-gray-400';
                                sleepStatusText.className += ' text-gray-400';
                                sleepStatusText.textContent = 'No Child';
                                break;
                            case 'Disabled':
                            case 'DISABLED':
                                sleepStatusIcon.className += ' fa-moon-o text-red-400';
                                sleepStatusText.className += ' text-red-400';
                                break;
                            default:
                                sleepStatusIcon.className += ' fa-question text-orange-400';
                                sleepStatusText.className += ' text-orange-400';
                                break;
                        }
                    }

                    // Remove all color classes from main sleep state element
                    sleepStateElement.classList.remove('text-green-400', 'text-blue-400', 'text-gray-400', 'text-orange-400', 'text-red-400');

                    // Apply color based on state
                    switch (data.sleep_state) {
                        case 'Sleep':
                            sleepStateElement.classList.add('text-green-400');
                            break;
                        case 'Awake':
                            sleepStateElement.classList.add('text-blue-400');
                            break;
                        case 'No child':
                            sleepStateElement.classList.add('text-gray-400');
                            break;
                        case 'Disabled':
                            sleepStateElement.classList.add('text-red-400');
                            break;
                        default:
                            sleepStateElement.classList.add('text-orange-400');
                            break;
                    }

                    document.getElementById('room-temp').textContent = data.room_temp + '°C';
                    document.getElementById('sleep-time').textContent = data.sleep_time;

                    // Update streaming metrics if available
                    if (data.streaming) {
                        currentQuality.textContent = data.streaming.adaptive_quality;
                        if (!streamActive || frameCount === 0) {
                            // Update server-side FPS if client isn't calculating
                            streamFps.textContent = data.streaming.adaptive_fps + ' FPS';
                        }
                    }

                    // System Status Bars
                    const cpuBar = document.getElementById('cpu-bar');
                    const memoryBar = document.getElementById('memory-bar');
                    const networkBar = document.getElementById('network-bar');
                    if (cpuBar) {
                        cpuBar.style.width = Math.max(10, Math.min(100, data.cpu)) + '%';
                        document.getElementById('cpu-value').textContent = Math.round(data.cpu) + '%';
                    }
                    if (memoryBar) {
                        memoryBar.style.width = Math.max(10, Math.min(100, data.memory)) + '%';
                        document.getElementById('memory-value').textContent = Math.round(data.memory) + '%';
                    }
                    if (networkBar) {
                        networkBar.style.width = Math.max(10, Math.min(100, data.network)) + '%';
                        document.getElementById('network-value').textContent = Math.round(data.network) + '%';
                    }
                })
                .catch(error => console.error('Error updating metrics:', error));
        }

        setInterval(updateMetrics, 3000);
        window.onload = updateMetrics;

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');

                if (dropdown.classList.contains('show')) {
                    loadNotificationsList();
                }
            }
        }

        // Toggle user dropdown
        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside (extended to handle user menu)
        document.addEventListener('click', function (event) {
            const notificationContainer = document.querySelector('.notifications-container');
            const userContainer = document.querySelector('.user-menu');

            if (notificationContainer && !notificationContainer.contains(event.target)) {
                const dropdown = document.getElementById('notifications-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }

            if (userContainer && !userContainer.contains(event.target)) {
                const dropdown = document.getElementById('user-dropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });

        // Load notifications list
        function loadNotificationsList() {
            fetch('/notifications')
                .then(response => response.json())
                .then(data => {
                    const list = document.getElementById('notifications-list');
                    const badge = document.getElementById('notification-badge');

                    if (list && badge && data.notifications && data.notifications.length > 0) {
                        // Update badge
                        badge.textContent = data.notifications.length;
                        badge.style.display = data.notifications.length > 0 ? 'flex' : 'none';

                        // Populate list
                        list.innerHTML = data.notifications
                            .slice(-20) // Last 20 notifications
                            .reverse() // Most recent first
                            .map(notification => {
                                const time = new Date(notification.timestamp).toLocaleTimeString();
                                return `
                                    <div class="notification-item notification-${notification.type}">
                                        <div class="notification-title">${notification.title}</div>
                                        <div class="notification-message">${notification.message}</div>
                                        <div class="notification-time">${time}</div>
                                    </div>
                                `;
                            }).join('');
                    } else if (list) {
                        if (badge) badge.style.display = 'none';
                        list.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">No notifications yet</div>';
                    }
                })
                .catch(error => console.error('Error loading notifications:', error));
        }

        // Auto-start stream when page loads
        window.addEventListener('load', function () {
            console.log('Page loaded, WebSocket should connect automatically');
            // Show keyboard shortcuts hint
            setTimeout(() => {
                showNotification('Press H for shortcuts help. Quick keys: S=Snapshot, P=Pause, F=Fullscreen', 'info');
            }, 2000);

            // Request initial child status
            setTimeout(() => {
                requestChildStatus();
            }, 1000);

            // Initialize camera controls if available
            if (typeof initializeCameraControls === 'function') {
                setTimeout(() => {
                    initializeCameraControls();
                }, 500);
            }
        });

        // Periodically update child status
        setInterval(requestChildStatus, 2000);

        // Toggle shortcuts help modal
        function toggleShortcutsHelp() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal.style.display === 'none' || modal.style.display === '') {
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        // Toggle sleep detection
        function toggleSleepDetection() {
            socket.emit('toggle_sleep_detection');
        }

        // Toggle recording mode (raw/annotated)
        function toggleRecordingMode() {
            socket.emit('toggle_recording_mode');
        }

        // Handle sleep detection WebSocket events
        socket.on('sleep_detection_toggled', function (data) {
            if (data.success) {
                const status = data.enabled ? 'enabled' : 'disabled';
                showNotification(`Sleep detection ${status}`, data.enabled ? 'success' : 'warning');

                // Update sleep status indicator immediately
                const sleepStatusIcon = document.getElementById('sleep-status-icon');
                const sleepStatusText = document.getElementById('sleep-status-text');

                if (!data.enabled) {
                    // If disabled, show disabled status
                    sleepStatusIcon.className = 'fas fa-moon-o text-red-400';
                    sleepStatusText.className = 'font-medium text-red-400';
                    sleepStatusText.textContent = 'Disabled';
                } else {
                    // If enabled, it will be updated by the next metrics call
                    sleepStatusIcon.className = 'fas fa-moon text-blue-400';
                    sleepStatusText.className = 'font-medium text-blue-400';
                    sleepStatusText.textContent = 'Enabled';
                }
            }
        });

        socket.on('sleep_detection_error', function (data) {
            showNotification('Failed to toggle sleep detection: ' + data.message, 'error');
        });

        // Handle recording mode WebSocket events
        socket.on('recording_mode_toggled', function (data) {
            if (data.success) {
                const mode = data.annotated ? 'annotated (with AI overlay)' : 'raw (clean video)';
                showNotification(`Recording mode: ${mode}`, 'info');
            }
        });

        socket.on('recording_mode_error', function (data) {
            showNotification('Failed to toggle recording mode: ' + data.message, 'error');
        });

        // Close modal when clicking outside
        document.getElementById('shortcuts-modal').addEventListener('click', function (event) {
            if (event.target === this) {
                toggleShortcutsHelp();
            }
        });
    </script>

    <script>
        // Update the existing fetchNotifications to also update the badge
        const originalFetchNotifications = fetchNotifications;
        fetchNotifications = function () {
            originalFetchNotifications();

            // Also update badge count
            fetch('/notifications')
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notification-badge');
                    if (data.notifications && data.notifications.length > 0) {
                        badge.textContent = data.notifications.length;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                })
                .catch(error => console.error('Error updating badge:', error));
        };

        // Poll for notifications every 2 seconds
        setInterval(fetchNotifications, 2000);

        // Active viewers functions (admin only)
        function joinAdminRoom() {
            if (document.getElementById('active-viewers-card')) {
                socket.emit('join_admin_room');
            }
        }

        function updateActiveViewers(activeUsers, count) {
            const countBadge = document.getElementById('active-count-badge');
            const viewersList = document.getElementById('active-viewers-list');

            if (!countBadge || !viewersList) return;

            // Update count badge
            countBadge.textContent = count;

            // Clear existing list
            viewersList.innerHTML = '';

            if (activeUsers.length === 0) {
                viewersList.innerHTML = `
                    <div class="text-center text-gray-400 text-sm py-4">
                        <i class="fas fa-user-clock text-2xl mb-2"></i>
                        <p>No active viewers</p>
                    </div>
                `;
                return;
            }

            // Add each active user
            activeUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'feature-card rounded-xl p-3 flex items-center gap-3';

                const relationshipIcons = {
                    'Father': 'fa-male',
                    'Mother': 'fa-female',
                    'Guardian': 'fa-shield-alt',
                    'Grandparent': 'fa-heart',
                    'Babysitter': 'fa-child',
                    'Other': 'fa-user'
                };

                const relationshipColors = {
                    'Father': 'text-blue-400',
                    'Mother': 'text-pink-400',
                    'Guardian': 'text-green-400',
                    'Grandparent': 'text-purple-400',
                    'Babysitter': 'text-yellow-400',
                    'Other': 'text-gray-400'
                };

                const icon = relationshipIcons[user.relationship] || 'fa-user';
                const color = relationshipColors[user.relationship] || 'text-gray-400';
                const isCurrentUser = user.user_id == currentUserId;

                userElement.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 flex items-center justify-center text-white font-medium text-xs">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-white text-sm">${user.username}</span>
                            ${isCurrentUser ? '<span class="text-xs bg-cyan-500 bg-opacity-20 text-cyan-400 px-2 py-0.5 rounded-full border border-cyan-400">You</span>' : ''}
                            ${user.is_admin ? '<span class="text-xs bg-purple-500 bg-opacity-20 text-purple-400 px-2 py-0.5 rounded-full border border-purple-400"><i class="fas fa-crown mr-1"></i>Admin</span>' : ''}
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <i class="fas ${icon} ${color} text-xs"></i>
                            <span class="text-xs ${color}">${user.relationship}</span>
                            <span class="text-xs text-gray-500">•</span>
                            <span class="text-xs text-gray-400">Active now</span>
                        </div>
                    </div>
                    <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                `;

                viewersList.appendChild(userElement);
            });
        }

        // Send heartbeat every 30 seconds to keep user active
        setInterval(function () {
            if (socket.connected) {
                socket.emit('user_heartbeat');
            }
        }, 30000);

        // Clear all notifications function
        function clearAllNotifications() {
            fetch('/notifications/clear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('All notifications cleared', 'success');
                        loadNotificationsList();
                    } else {
                        showNotification('Failed to clear notifications', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error clearing notifications:', error);
                    showNotification('Failed to clear notifications', 'error');
                });
        }

        // Update notification badge styles
        const notificationBadgeStyles = `
            .notification-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(45deg, #ef4444, #dc2626);
                color: white;
                font-size: 10px;
                font-weight: bold;
                padding: 2px 6px;
                border-radius: 12px;
                min-width: 18px;
                height: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: badge-pulse 2s infinite;
            }
            
            @keyframes badge-pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            .notification-title {
                font-weight: bold;
                margin-bottom: 2px;
                color: #ffffff;
            }
            
            .notification-message {
                font-size: 12px;
                color: #d1d5db;
                margin-bottom: 4px;
                line-height: 1.3;
            }
            
            .notification-time {
                font-size: 10px;
                color: #9ca3af;
            }
            
            .notification-success {
                border-left: 3px solid #10b981;
                background: rgba(16, 185, 129, 0.05);
            }
            
            .notification-error {
                border-left: 3px solid #ef4444;
                background: rgba(239, 68, 68, 0.05);
            }
            
            .notification-warning {
                border-left: 3px solid #f59e0b;
                background: rgba(245, 158, 11, 0.05);
            }
            
            .notification-info {
                border-left: 3px solid #3b82f6;
                background: rgba(59, 130, 246, 0.05);
            }
        `;

        // Inject notification styles
        const styleSheet = document.createElement('style');
        styleSheet.textContent = notificationBadgeStyles;
        document.head.appendChild(styleSheet);

        // Initialize notification badge on page load (delayed to allow camera controls to init first)
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => {
                loadNotificationsList();
                
                // Also try to initialize camera controls if they haven't been initialized yet
                if (typeof window.initializeCameraControlsWrapper === 'function') {
                    console.log('🔧 Ensuring camera controls are initialized from main script...');
                    window.initializeCameraControlsWrapper();
                }
            }, 200);
        });

        // Enhanced error handling for WebSocket events
        socket.on('error', function (error) {
            console.error('WebSocket error:', error);
            showNotification('Connection error occurred', 'error');
        });

        socket.on('reconnect', function () {
            showNotification('Reconnected to server', 'success');
            checkStreamingPermissions();
            requestChildStatus();
        });

        socket.on('reconnect_error', function () {
            showNotification('Failed to reconnect to server', 'error');
        });

        // Performance monitoring
        let performanceStats = {
            frameDrops: 0,
            lastFrameTime: 0,
            avgFps: 0,
            fpsHistory: []
        };

        // Monitor video performance
        function updatePerformanceStats(fps) {
            performanceStats.fpsHistory.push(fps);
            if (performanceStats.fpsHistory.length > 10) {
                performanceStats.fpsHistory.shift();
            }

            performanceStats.avgFps = performanceStats.fpsHistory.reduce((a, b) => a + b, 0) / performanceStats.fpsHistory.length;

            // Detect frame drops
            if (fps < performanceStats.avgFps * 0.7) {
                performanceStats.frameDrops++;
            }
        }

        // Auto-adjust quality based on performance
        function autoAdjustQuality() {
            if (performanceStats.frameDrops > 5) {
                const currentQual = parseInt(qualitySlider.value);
                if (currentQual > 30) {
                    qualitySlider.value = Math.max(30, currentQual - 10);
                    qualityValue.textContent = qualitySlider.value + '%';
                    applyQuality.click();
                    showNotification('Quality auto-adjusted due to performance', 'info');
                    performanceStats.frameDrops = 0;
                }
            }
        }

        // Check performance every 30 seconds
        setInterval(autoAdjustQuality, 30000);

        // Enhanced video stream error handling
        videoStream.addEventListener('error', function (e) {
            console.error('Video stream error:', e);
            showNotification('Video stream error occurred', 'error');
        });

        videoStream.addEventListener('loadstart', function () {
            console.log('Video stream loading started');
        });

        videoStream.addEventListener('loadeddata', function () {
            console.log('Video stream data loaded');
        });

        // Keyboard shortcut hints
        const shortcutHints = {
            's': 'Take Snapshot',
            'p': 'Pause/Resume',
            'f': 'Fullscreen',
            'q': 'Toggle Quality',
            'c': 'Clear Child Selection',
            'r': 'Recording Mode',
            'z': 'Sleep Detection',
            'h': 'Help'
        };

        // Show random shortcut hint occasionally
        function showRandomShortcutHint() {
            const shortcuts = Object.keys(shortcutHints);
            const randomKey = shortcuts[Math.floor(Math.random() * shortcuts.length)];
            const hint = shortcutHints[randomKey];
            showNotification(`💡 Tip: Press "${randomKey.toUpperCase()}" to ${hint}`, 'info');
        }

        // Show hint every 5 minutes
        setInterval(showRandomShortcutHint, 300000);

        console.log('🚀 AI Baby Monitor initialized successfully!');
        console.log('📹 Video stream ready');
        console.log('🔌 WebSocket connection established');
        console.log('⌨️ Press H for keyboard shortcuts');

    </script>